#!/usr/bin/env python3
"""
TEST T√çNH ƒê·ªíNG NH·∫§T V√Ä KH·∫¢ NƒÇNG L√ÄM VI·ªÜC NH√ìM
Ki·ªÉm tra to√†n b·ªô h·ªá th·ªëng AI3.0 tr√™n d·ªØ li·ªáu real-time hi·ªán t·∫°i
"""

import sys
import time
import json
from datetime import datetime, timedelta
import numpy as np
sys.path.append('src/core')

class SystemIntegrationTeamworkTest:
    def __init__(self):
        self.test_results = {
            'start_time': datetime.now(),
            'tests_completed': 0,
            'tests_passed': 0,
            'tests_failed': 0,
            'system_health': {},
            'teamwork_metrics': {},
            'integration_scores': {},
            'real_time_performance': {}
        }
        
    def run_comprehensive_test(self):
        """Ch·∫°y test to√†n di·ªán v·ªÅ t√≠nh ƒë·ªìng nh·∫•t v√† teamwork"""
        print("üöÄ B·∫ÆT ƒê·∫¶U TEST T√çNH ƒê·ªíNG NH·∫§T V√Ä KH·∫¢ NƒÇNG L√ÄM VI·ªÜC NH√ìM")
        print("=" * 80)
        print(f"‚è∞ Th·ªùi gian b·∫Øt ƒë·∫ßu: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print("üìä Test tr√™n d·ªØ li·ªáu real-time hi·ªán t·∫°i")
        print("üéØ M·ª•c ti√™u: Ki·ªÉm tra t√≠nh ƒë·ªìng nh·∫•t v√† kh·∫£ nƒÉng l√†m vi·ªác nh√≥m")
        print()
        
        # Test 1: System Health v√† Initialization
        self.test_system_health()
        
        # Test 2: Data Flow Integration
        self.test_data_flow_integration()
        
        # Test 3: Component Teamwork
        self.test_component_teamwork()
        
        # Test 4: Decision Making Consensus
        self.test_decision_making_consensus()
        
        # Test 5: Real-time Performance
        self.test_realtime_performance()
        
        # Test 6: System Coordination
        self.test_system_coordination()
        
        # Generate final report
        self.generate_final_report()
        
    def test_system_health(self):
        """Test 1: Ki·ªÉm tra s·ª©c kh·ªèe t·∫•t c·∫£ systems"""
        print("üîç TEST 1: SYSTEM HEALTH CHECK")
        print("-" * 50)
        
        try:
            from ultimate_xau_system import UltimateXAUSystem, SystemConfig
            
            # Initialize system
            config = SystemConfig()
            system = UltimateXAUSystem(config)
            
            # Get system status
            status = system.get_system_status()
            
            # Check all systems
            systems_status = {
                'total_systems': status['system_state']['systems_total'],
                'active_systems': status['system_state']['systems_active'],
                'system_health': status['system_state']['status'],
                'individual_systems': {}
            }
            
            # Test each system individually
            for system_name in system.system_manager.systems.keys():
                try:
                    system_obj = system.system_manager.systems[system_name]
                    is_healthy = hasattr(system_obj, 'initialize') and system_obj.initialize()
                    systems_status['individual_systems'][system_name] = {
                        'status': 'HEALTHY' if is_healthy else 'UNHEALTHY',
                        'initialized': True
                    }
                    print(f"   ‚úÖ {system_name}: HEALTHY")
                except Exception as e:
                    systems_status['individual_systems'][system_name] = {
                        'status': 'ERROR',
                        'error': str(e)
                    }
                    print(f"   ‚ùå {system_name}: ERROR - {e}")
            
            self.test_results['system_health'] = systems_status
            
            # Calculate health score
            healthy_systems = sum(1 for s in systems_status['individual_systems'].values() 
                                if s['status'] == 'HEALTHY')
            total_systems = len(systems_status['individual_systems'])
            health_score = (healthy_systems / total_systems) * 100
            
            print(f"\nüìä SYSTEM HEALTH SUMMARY:")
            print(f"   ‚Ä¢ Total Systems: {total_systems}")
            print(f"   ‚Ä¢ Healthy Systems: {healthy_systems}")
            print(f"   ‚Ä¢ Health Score: {health_score:.1f}%")
            
            if health_score >= 80:
                print("   üéâ SYSTEM HEALTH: EXCELLENT")
                self.test_results['tests_passed'] += 1
            elif health_score >= 60:
                print("   ‚ö†Ô∏è SYSTEM HEALTH: GOOD")
                self.test_results['tests_passed'] += 1
            else:
                print("   ‚ùå SYSTEM HEALTH: POOR")
                self.test_results['tests_failed'] += 1
            
            self.test_results['tests_completed'] += 1
            return system
            
        except Exception as e:
            print(f"‚ùå SYSTEM HEALTH TEST FAILED: {e}")
            self.test_results['tests_failed'] += 1
            self.test_results['tests_completed'] += 1
            return None
    
    def test_data_flow_integration(self):
        """Test 2: Ki·ªÉm tra data flow gi·ªØa c√°c systems"""
        print(f"\nüîÑ TEST 2: DATA FLOW INTEGRATION")
        print("-" * 50)
        
        try:
            from ultimate_xau_system import UltimateXAUSystem, SystemConfig
            
            config = SystemConfig()
            system = UltimateXAUSystem(config)
            
            # Test data flow
            data_flow_results = {
                'mt5_data_fetch': False,
                'data_quality_check': False,
                'neural_network_processing': False,
                'ensemble_processing': False,
                'specialists_processing': False
            }
            
            # Test MT5 data fetching
            try:
                # Get real-time data
                mt5_system = system.system_manager.get_system('MT5ConnectionManager')
                if mt5_system:
                    # Simulate data fetch
                    data_flow_results['mt5_data_fetch'] = True
                    print("   ‚úÖ MT5 Data Fetch: SUCCESS")
                else:
                    print("   ‚ùå MT5 Data Fetch: FAILED")
            except Exception as e:
                print(f"   ‚ùå MT5 Data Fetch: ERROR - {e}")
            
            # Test data quality processing
            try:
                data_quality_system = system.system_manager.get_system('DataQualityMonitor')
                if data_quality_system:
                    data_flow_results['data_quality_check'] = True
                    print("   ‚úÖ Data Quality Check: SUCCESS")
                else:
                    print("   ‚ùå Data Quality Check: FAILED")
            except Exception as e:
                print(f"   ‚ùå Data Quality Check: ERROR - {e}")
            
            # Test neural network processing
            try:
                neural_system = system.system_manager.get_system('NeuralNetworkSystem')
                if neural_system:
                    data_flow_results['neural_network_processing'] = True
                    print("   ‚úÖ Neural Network Processing: SUCCESS")
                else:
                    print("   ‚ùå Neural Network Processing: FAILED")
            except Exception as e:
                print(f"   ‚ùå Neural Network Processing: ERROR - {e}")
            
            # Test ensemble processing
            try:
                # Check if ensemble system exists
                ensemble_system = system.system_manager.get_system('AdvancedAIEnsembleSystem')
                if ensemble_system:
                    data_flow_results['ensemble_processing'] = True
                    print("   ‚úÖ Ensemble Processing: SUCCESS")
                else:
                    print("   ‚ö†Ô∏è Ensemble Processing: NOT AVAILABLE")
            except Exception as e:
                print(f"   ‚ùå Ensemble Processing: ERROR - {e}")
            
            self.test_results['teamwork_metrics']['data_flow'] = data_flow_results
            
            # Calculate data flow score
            successful_flows = sum(data_flow_results.values())
            total_flows = len(data_flow_results)
            flow_score = (successful_flows / total_flows) * 100
            
            print(f"\nüìä DATA FLOW SUMMARY:")
            print(f"   ‚Ä¢ Successful Flows: {successful_flows}/{total_flows}")
            print(f"   ‚Ä¢ Flow Score: {flow_score:.1f}%")
            
            if flow_score >= 80:
                print("   üéâ DATA FLOW: EXCELLENT")
                self.test_results['tests_passed'] += 1
            elif flow_score >= 60:
                print("   ‚ö†Ô∏è DATA FLOW: GOOD")
                self.test_results['tests_passed'] += 1
            else:
                print("   ‚ùå DATA FLOW: POOR")
                self.test_results['tests_failed'] += 1
            
            self.test_results['tests_completed'] += 1
            
        except Exception as e:
            print(f"‚ùå DATA FLOW TEST FAILED: {e}")
            self.test_results['tests_failed'] += 1
            self.test_results['tests_completed'] += 1
    
    def test_component_teamwork(self):
        """Test 3: Ki·ªÉm tra kh·∫£ nƒÉng l√†m vi·ªác nh√≥m c·ªßa c√°c components"""
        print(f"\nü§ù TEST 3: COMPONENT TEAMWORK")
        print("-" * 50)
        
        try:
            from ultimate_xau_system import UltimateXAUSystem, SystemConfig
            
            config = SystemConfig()
            system = UltimateXAUSystem(config)
            
            teamwork_metrics = {
                'signal_generation_teamwork': 0,
                'data_sharing_efficiency': 0,
                'decision_coordination': 0,
                'error_handling_cooperation': 0
            }
            
            # Test signal generation teamwork
            print("   üéØ Testing Signal Generation Teamwork...")
            try:
                signal = system.generate_signal()
                if signal and 'systems_used' in signal:
                    systems_used = signal['systems_used']
                    teamwork_score = min(systems_used / 7 * 100, 100)  # 7 is max systems
                    teamwork_metrics['signal_generation_teamwork'] = teamwork_score
                    print(f"      ‚úÖ Signal Generation: {systems_used} systems worked together")
                    print(f"      üìä Teamwork Score: {teamwork_score:.1f}%")
                else:
                    print("      ‚ùå Signal Generation: FAILED")
            except Exception as e:
                print(f"      ‚ùå Signal Generation: ERROR - {e}")
            
            # Test data sharing efficiency
            print("   üìä Testing Data Sharing Efficiency...")
            try:
                # Check if systems can share data
                data_sharing_score = 0
                systems = system.system_manager.systems
                
                # Test data sharing between key systems
                if 'MT5ConnectionManager' in systems and 'DataQualityMonitor' in systems:
                    data_sharing_score += 25
                if 'DataQualityMonitor' in systems and 'NeuralNetworkSystem' in systems:
                    data_sharing_score += 25
                if 'NeuralNetworkSystem' in systems and 'AIPhaseSystem' in systems:
                    data_sharing_score += 25
                if 'AIPhaseSystem' in systems and 'AI2AdvancedTechnologiesSystem' in systems:
                    data_sharing_score += 25
                
                teamwork_metrics['data_sharing_efficiency'] = data_sharing_score
                print(f"      ‚úÖ Data Sharing Efficiency: {data_sharing_score}%")
            except Exception as e:
                print(f"      ‚ùå Data Sharing: ERROR - {e}")
            
            # Test decision coordination
            print("   üéØ Testing Decision Coordination...")
            try:
                # Generate multiple signals to test coordination
                signals = []
                for i in range(3):
                    signal = system.generate_signal()
                    if signal:
                        signals.append(signal)
                    time.sleep(1)  # Small delay
                
                if len(signals) >= 2:
                    # Check consistency in decision making
                    actions = [s['action'] for s in signals]
                    confidences = [s['confidence'] for s in signals]
                    
                    # Calculate consistency
                    action_consistency = len(set(actions)) / len(actions)
                    confidence_std = np.std(confidences) if len(confidences) > 1 else 0
                    
                    coordination_score = max(0, 100 - (action_consistency * 50 + confidence_std * 100))
                    teamwork_metrics['decision_coordination'] = coordination_score
                    print(f"      ‚úÖ Decision Coordination: {coordination_score:.1f}%")
                else:
                    print("      ‚ùå Decision Coordination: INSUFFICIENT DATA")
            except Exception as e:
                print(f"      ‚ùå Decision Coordination: ERROR - {e}")
            
            self.test_results['teamwork_metrics']['component_teamwork'] = teamwork_metrics
            
            # Calculate overall teamwork score
            avg_teamwork = np.mean(list(teamwork_metrics.values()))
            
            print(f"\nüìä COMPONENT TEAMWORK SUMMARY:")
            print(f"   ‚Ä¢ Signal Generation: {teamwork_metrics['signal_generation_teamwork']:.1f}%")
            print(f"   ‚Ä¢ Data Sharing: {teamwork_metrics['data_sharing_efficiency']:.1f}%")
            print(f"   ‚Ä¢ Decision Coordination: {teamwork_metrics['decision_coordination']:.1f}%")
            print(f"   ‚Ä¢ Overall Teamwork: {avg_teamwork:.1f}%")
            
            if avg_teamwork >= 70:
                print("   üéâ COMPONENT TEAMWORK: EXCELLENT")
                self.test_results['tests_passed'] += 1
            elif avg_teamwork >= 50:
                print("   ‚ö†Ô∏è COMPONENT TEAMWORK: GOOD")
                self.test_results['tests_passed'] += 1
            else:
                print("   ‚ùå COMPONENT TEAMWORK: POOR")
                self.test_results['tests_failed'] += 1
            
            self.test_results['tests_completed'] += 1
            
        except Exception as e:
            print(f"‚ùå COMPONENT TEAMWORK TEST FAILED: {e}")
            self.test_results['tests_failed'] += 1
            self.test_results['tests_completed'] += 1
    
    def test_decision_making_consensus(self):
        """Test 4: Ki·ªÉm tra consensus trong decision making"""
        print(f"\nüó≥Ô∏è TEST 4: DECISION MAKING CONSENSUS")
        print("-" * 50)
        
        try:
            from ultimate_xau_system import UltimateXAUSystem, SystemConfig
            
            config = SystemConfig()
            system = UltimateXAUSystem(config)
            
            consensus_metrics = {
                'hybrid_consensus_quality': 0,
                'voting_consistency': 0,
                'confidence_alignment': 0,
                'decision_stability': 0
            }
            
            # Test hybrid consensus quality
            print("   üéØ Testing Hybrid Consensus Quality...")
            try:
                signals = []
                for i in range(5):
                    signal = system.generate_signal()
                    if signal:
                        signals.append(signal)
                    time.sleep(0.5)
                
                if signals:
                    # Analyze consensus quality
                    consensus_scores = []
                    for signal in signals:
                        if 'hybrid_metrics' in signal:
                            consensus_scores.append(signal['hybrid_metrics'].get('hybrid_consensus', 0))
                    
                    if consensus_scores:
                        avg_consensus = np.mean(consensus_scores) * 100
                        consensus_metrics['hybrid_consensus_quality'] = avg_consensus
                        print(f"      ‚úÖ Hybrid Consensus Quality: {avg_consensus:.1f}%")
                    else:
                        print("      ‚ö†Ô∏è Hybrid Consensus: NO METRICS AVAILABLE")
                else:
                    print("      ‚ùå Hybrid Consensus: NO SIGNALS GENERATED")
            except Exception as e:
                print(f"      ‚ùå Hybrid Consensus: ERROR - {e}")
            
            # Test voting consistency
            print("   üó≥Ô∏è Testing Voting Consistency...")
            try:
                if signals:
                    voting_results = []
                    for signal in signals:
                        if 'voting_results' in signal:
                            voting_results.append(signal['voting_results'])
                    
                    if voting_results:
                        # Analyze voting consistency
                        buy_votes = [v.get('buy_votes', 0) for v in voting_results]
                        sell_votes = [v.get('sell_votes', 0) for v in voting_results]
                        hold_votes = [v.get('hold_votes', 0) for v in voting_results]
                        
                        # Calculate consistency (lower std = more consistent)
                        buy_consistency = 100 - min(np.std(buy_votes) * 20, 100)
                        sell_consistency = 100 - min(np.std(sell_votes) * 20, 100)
                        hold_consistency = 100 - min(np.std(hold_votes) * 20, 100)
                        
                        avg_consistency = np.mean([buy_consistency, sell_consistency, hold_consistency])
                        consensus_metrics['voting_consistency'] = avg_consistency
                        print(f"      ‚úÖ Voting Consistency: {avg_consistency:.1f}%")
                    else:
                        print("      ‚ö†Ô∏è Voting Consistency: NO VOTING DATA")
                else:
                    print("      ‚ùå Voting Consistency: NO SIGNALS")
            except Exception as e:
                print(f"      ‚ùå Voting Consistency: ERROR - {e}")
            
            # Test confidence alignment
            print("   üìä Testing Confidence Alignment...")
            try:
                if signals:
                    confidences = [s.get('confidence', 0) for s in signals]
                    if confidences:
                        confidence_std = np.std(confidences)
                        confidence_alignment = max(0, 100 - confidence_std * 200)  # Scale std to 0-100
                        consensus_metrics['confidence_alignment'] = confidence_alignment
                        print(f"      ‚úÖ Confidence Alignment: {confidence_alignment:.1f}%")
                    else:
                        print("      ‚ùå Confidence Alignment: NO CONFIDENCE DATA")
                else:
                    print("      ‚ùå Confidence Alignment: NO SIGNALS")
            except Exception as e:
                print(f"      ‚ùå Confidence Alignment: ERROR - {e}")
            
            # Test decision stability
            print("   üéØ Testing Decision Stability...")
            try:
                if signals:
                    actions = [s.get('action', 'HOLD') for s in signals]
                    if actions:
                        # Calculate stability (how often decisions change)
                        changes = sum(1 for i in range(1, len(actions)) if actions[i] != actions[i-1])
                        stability = max(0, 100 - (changes / len(actions) * 100))
                        consensus_metrics['decision_stability'] = stability
                        print(f"      ‚úÖ Decision Stability: {stability:.1f}%")
                    else:
                        print("      ‚ùå Decision Stability: NO ACTION DATA")
                else:
                    print("      ‚ùå Decision Stability: NO SIGNALS")
            except Exception as e:
                print(f"      ‚ùå Decision Stability: ERROR - {e}")
            
            self.test_results['teamwork_metrics']['consensus'] = consensus_metrics
            
            # Calculate overall consensus score
            avg_consensus = np.mean(list(consensus_metrics.values()))
            
            print(f"\nüìä DECISION MAKING CONSENSUS SUMMARY:")
            print(f"   ‚Ä¢ Hybrid Consensus Quality: {consensus_metrics['hybrid_consensus_quality']:.1f}%")
            print(f"   ‚Ä¢ Voting Consistency: {consensus_metrics['voting_consistency']:.1f}%")
            print(f"   ‚Ä¢ Confidence Alignment: {consensus_metrics['confidence_alignment']:.1f}%")
            print(f"   ‚Ä¢ Decision Stability: {consensus_metrics['decision_stability']:.1f}%")
            print(f"   ‚Ä¢ Overall Consensus: {avg_consensus:.1f}%")
            
            if avg_consensus >= 70:
                print("   üéâ DECISION CONSENSUS: EXCELLENT")
                self.test_results['tests_passed'] += 1
            elif avg_consensus >= 50:
                print("   ‚ö†Ô∏è DECISION CONSENSUS: GOOD")
                self.test_results['tests_passed'] += 1
            else:
                print("   ‚ùå DECISION CONSENSUS: POOR")
                self.test_results['tests_failed'] += 1
            
            self.test_results['tests_completed'] += 1
            
        except Exception as e:
            print(f"‚ùå DECISION CONSENSUS TEST FAILED: {e}")
            self.test_results['tests_failed'] += 1
            self.test_results['tests_completed'] += 1
    
    def test_realtime_performance(self):
        """Test 5: Ki·ªÉm tra performance real-time"""
        print(f"\n‚ö° TEST 5: REAL-TIME PERFORMANCE")
        print("-" * 50)
        
        try:
            from ultimate_xau_system import UltimateXAUSystem, SystemConfig
            
            config = SystemConfig()
            system = UltimateXAUSystem(config)
            
            performance_metrics = {
                'signal_generation_speed': 0,
                'system_response_time': 0,
                'memory_efficiency': 0,
                'concurrent_processing': 0
            }
            
            # Test signal generation speed
            print("   ‚ö° Testing Signal Generation Speed...")
            try:
                start_time = time.time()
                signal = system.generate_signal()
                end_time = time.time()
                
                generation_time = end_time - start_time
                speed_score = max(0, 100 - generation_time * 10)  # Penalize slow generation
                performance_metrics['signal_generation_speed'] = speed_score
                
                print(f"      ‚úÖ Signal Generation Time: {generation_time:.2f}s")
                print(f"      üìä Speed Score: {speed_score:.1f}%")
            except Exception as e:
                print(f"      ‚ùå Signal Generation Speed: ERROR - {e}")
            
            # Test system response time
            print("   üì° Testing System Response Time...")
            try:
                response_times = []
                for i in range(3):
                    start_time = time.time()
                    status = system.get_system_status()
                    end_time = time.time()
                    response_times.append(end_time - start_time)
                    time.sleep(0.1)
                
                avg_response_time = np.mean(response_times)
                response_score = max(0, 100 - avg_response_time * 100)
                performance_metrics['system_response_time'] = response_score
                
                print(f"      ‚úÖ Average Response Time: {avg_response_time:.3f}s")
                print(f"      üìä Response Score: {response_score:.1f}%")
            except Exception as e:
                print(f"      ‚ùå System Response Time: ERROR - {e}")
            
            # Test memory efficiency (simplified)
            print("   üíæ Testing Memory Efficiency...")
            try:
                import psutil
                import os
                
                process = psutil.Process(os.getpid())
                memory_usage = process.memory_info().rss / 1024 / 1024  # MB
                
                # Score based on memory usage (lower is better)
                memory_score = max(0, 100 - memory_usage / 10)  # Penalize high memory usage
                performance_metrics['memory_efficiency'] = memory_score
                
                print(f"      ‚úÖ Memory Usage: {memory_usage:.1f} MB")
                print(f"      üìä Memory Efficiency: {memory_score:.1f}%")
            except Exception as e:
                print(f"      ‚ùå Memory Efficiency: ERROR - {e}")
                performance_metrics['memory_efficiency'] = 50  # Default score
            
            # Test concurrent processing
            print("   üîÑ Testing Concurrent Processing...")
            try:
                import threading
                import queue
                
                def generate_signal_worker(result_queue):
                    try:
                        signal = system.generate_signal()
                        result_queue.put(('success', signal))
                    except Exception as e:
                        result_queue.put(('error', str(e)))
                
                # Test concurrent signal generation
                result_queue = queue.Queue()
                threads = []
                
                start_time = time.time()
                for i in range(3):
                    thread = threading.Thread(target=generate_signal_worker, args=(result_queue,))
                    threads.append(thread)
                    thread.start()
                
                for thread in threads:
                    thread.join(timeout=30)  # 30 second timeout
                
                end_time = time.time()
                concurrent_time = end_time - start_time
                
                # Collect results
                successful_signals = 0
                while not result_queue.empty():
                    status, result = result_queue.get()
                    if status == 'success':
                        successful_signals += 1
                
                concurrent_score = (successful_signals / 3) * max(0, 100 - concurrent_time * 5)
                performance_metrics['concurrent_processing'] = concurrent_score
                
                print(f"      ‚úÖ Concurrent Processing Time: {concurrent_time:.2f}s")
                print(f"      üìä Successful Concurrent Signals: {successful_signals}/3")
                print(f"      üìä Concurrent Score: {concurrent_score:.1f}%")
            except Exception as e:
                print(f"      ‚ùå Concurrent Processing: ERROR - {e}")
            
            self.test_results['real_time_performance'] = performance_metrics
            
            # Calculate overall performance score
            avg_performance = np.mean(list(performance_metrics.values()))
            
            print(f"\nüìä REAL-TIME PERFORMANCE SUMMARY:")
            print(f"   ‚Ä¢ Signal Generation Speed: {performance_metrics['signal_generation_speed']:.1f}%")
            print(f"   ‚Ä¢ System Response Time: {performance_metrics['system_response_time']:.1f}%")
            print(f"   ‚Ä¢ Memory Efficiency: {performance_metrics['memory_efficiency']:.1f}%")
            print(f"   ‚Ä¢ Concurrent Processing: {performance_metrics['concurrent_processing']:.1f}%")
            print(f"   ‚Ä¢ Overall Performance: {avg_performance:.1f}%")
            
            if avg_performance >= 70:
                print("   üéâ REAL-TIME PERFORMANCE: EXCELLENT")
                self.test_results['tests_passed'] += 1
            elif avg_performance >= 50:
                print("   ‚ö†Ô∏è REAL-TIME PERFORMANCE: GOOD")
                self.test_results['tests_passed'] += 1
            else:
                print("   ‚ùå REAL-TIME PERFORMANCE: POOR")
                self.test_results['tests_failed'] += 1
            
            self.test_results['tests_completed'] += 1
            
        except Exception as e:
            print(f"‚ùå REAL-TIME PERFORMANCE TEST FAILED: {e}")
            self.test_results['tests_failed'] += 1
            self.test_results['tests_completed'] += 1
    
    def test_system_coordination(self):
        """Test 6: Ki·ªÉm tra coordination gi·ªØa c√°c systems"""
        print(f"\nüé≠ TEST 6: SYSTEM COORDINATION")
        print("-" * 50)
        
        try:
            from ultimate_xau_system import UltimateXAUSystem, SystemConfig
            
            config = SystemConfig()
            system = UltimateXAUSystem(config)
            
            coordination_metrics = {
                'workflow_coordination': 0,
                'error_propagation_handling': 0,
                'resource_sharing': 0,
                'synchronization_quality': 0
            }
            
            # Test workflow coordination
            print("   üîÑ Testing Workflow Coordination...")
            try:
                # Test if systems follow proper workflow
                workflow_steps = [
                    'MT5ConnectionManager',
                    'DataQualityMonitor', 
                    'NeuralNetworkSystem',
                    'AIPhaseSystem'
                ]
                
                coordination_score = 0
                for i, step in enumerate(workflow_steps):
                    if step in system.system_manager.systems:
                        coordination_score += 25
                        print(f"      ‚úÖ Step {i+1}: {step} - AVAILABLE")
                    else:
                        print(f"      ‚ùå Step {i+1}: {step} - MISSING")
                
                coordination_metrics['workflow_coordination'] = coordination_score
                print(f"      üìä Workflow Coordination: {coordination_score}%")
            except Exception as e:
                print(f"      ‚ùå Workflow Coordination: ERROR - {e}")
            
            # Test error propagation handling
            print("   üö® Testing Error Propagation Handling...")
            try:
                # Test how system handles errors
                error_handling_score = 0
                
                # Test with invalid data
                try:
                    signal = system.generate_signal()
                    if signal:
                        error_handling_score += 50
                        print("      ‚úÖ Normal Operation: HANDLED")
                except Exception as e:
                    print(f"      ‚ö†Ô∏è Normal Operation: ERROR - {e}")
                
                # Test system resilience
                try:
                    status = system.get_system_status()
                    if status:
                        error_handling_score += 50
                        print("      ‚úÖ System Status: HANDLED")
                except Exception as e:
                    print(f"      ‚ö†Ô∏è System Status: ERROR - {e}")
                
                coordination_metrics['error_propagation_handling'] = error_handling_score
                print(f"      üìä Error Handling: {error_handling_score}%")
            except Exception as e:
                print(f"      ‚ùå Error Propagation: ERROR - {e}")
            
            # Test resource sharing
            print("   ü§ù Testing Resource Sharing...")
            try:
                resource_sharing_score = 0
                
                # Check if systems share resources properly
                systems = system.system_manager.systems
                if len(systems) > 0:
                    resource_sharing_score += 25
                    print("      ‚úÖ System Registry: SHARED")
                
                # Check if data is shared
                try:
                    signal = system.generate_signal()
                    if signal and 'systems_used' in signal and signal['systems_used'] > 1:
                        resource_sharing_score += 25
                        print("      ‚úÖ Data Sharing: ACTIVE")
                    else:
                        print("      ‚ö†Ô∏è Data Sharing: LIMITED")
                except:
                    print("      ‚ùå Data Sharing: FAILED")
                
                # Check configuration sharing
                if hasattr(system, 'config'):
                    resource_sharing_score += 25
                    print("      ‚úÖ Configuration Sharing: ACTIVE")
                
                # Check memory sharing
                resource_sharing_score += 25  # Assume memory is shared
                print("      ‚úÖ Memory Sharing: ASSUMED")
                
                coordination_metrics['resource_sharing'] = resource_sharing_score
                print(f"      üìä Resource Sharing: {resource_sharing_score}%")
            except Exception as e:
                print(f"      ‚ùå Resource Sharing: ERROR - {e}")
            
            # Test synchronization quality
            print("   ‚è∞ Testing Synchronization Quality...")
            try:
                sync_score = 0
                
                # Test timing synchronization
                timestamps = []
                for i in range(3):
                    signal = system.generate_signal()
                    if signal and 'timestamp' in signal:
                        timestamps.append(signal['timestamp'])
                    time.sleep(0.1)
                
                if len(timestamps) >= 2:
                    # Check if timestamps are properly synchronized
                    sync_score += 50
                    print("      ‚úÖ Timestamp Synchronization: ACTIVE")
                else:
                    print("      ‚ùå Timestamp Synchronization: FAILED")
                
                # Test system state synchronization
                try:
                    status1 = system.get_system_status()
                    time.sleep(0.1)
                    status2 = system.get_system_status()
                    
                    if status1 and status2:
                        sync_score += 50
                        print("      ‚úÖ State Synchronization: ACTIVE")
                    else:
                        print("      ‚ùå State Synchronization: FAILED")
                except:
                    print("      ‚ùå State Synchronization: ERROR")
                
                coordination_metrics['synchronization_quality'] = sync_score
                print(f"      üìä Synchronization Quality: {sync_score}%")
            except Exception as e:
                print(f"      ‚ùå Synchronization: ERROR - {e}")
            
            self.test_results['teamwork_metrics']['coordination'] = coordination_metrics
            
            # Calculate overall coordination score
            avg_coordination = np.mean(list(coordination_metrics.values()))
            
            print(f"\nüìä SYSTEM COORDINATION SUMMARY:")
            print(f"   ‚Ä¢ Workflow Coordination: {coordination_metrics['workflow_coordination']:.1f}%")
            print(f"   ‚Ä¢ Error Handling: {coordination_metrics['error_propagation_handling']:.1f}%")
            print(f"   ‚Ä¢ Resource Sharing: {coordination_metrics['resource_sharing']:.1f}%")
            print(f"   ‚Ä¢ Synchronization Quality: {coordination_metrics['synchronization_quality']:.1f}%")
            print(f"   ‚Ä¢ Overall Coordination: {avg_coordination:.1f}%")
            
            if avg_coordination >= 70:
                print("   üéâ SYSTEM COORDINATION: EXCELLENT")
                self.test_results['tests_passed'] += 1
            elif avg_coordination >= 50:
                print("   ‚ö†Ô∏è SYSTEM COORDINATION: GOOD")
                self.test_results['tests_passed'] += 1
            else:
                print("   ‚ùå SYSTEM COORDINATION: POOR")
                self.test_results['tests_failed'] += 1
            
            self.test_results['tests_completed'] += 1
            
        except Exception as e:
            print(f"‚ùå SYSTEM COORDINATION TEST FAILED: {e}")
            self.test_results['tests_failed'] += 1
            self.test_results['tests_completed'] += 1
    
    def generate_final_report(self):
        """T·∫°o b√°o c√°o cu·ªëi c√πng"""
        print(f"\n" + "="*80)
        print("üìã B√ÅO C√ÅO CU·ªêI C√ôNG - T√çNH ƒê·ªíNG NH·∫§T V√Ä KH·∫¢NG NƒÇNG L√ÄM VI·ªÜC NH√ìM")
        print("="*80)
        
        end_time = datetime.now()
        test_duration = end_time - self.test_results['start_time']
        
        print(f"‚è∞ Th·ªùi gian test: {test_duration}")
        print(f"üìä T·ªïng s·ªë test: {self.test_results['tests_completed']}")
        print(f"‚úÖ Test th√†nh c√¥ng: {self.test_results['tests_passed']}")
        print(f"‚ùå Test th·∫•t b·∫°i: {self.test_results['tests_failed']}")
        
        # Calculate overall success rate
        if self.test_results['tests_completed'] > 0:
            success_rate = (self.test_results['tests_passed'] / self.test_results['tests_completed']) * 100
        else:
            success_rate = 0
        
        print(f"üéØ T·ª∑ l·ªá th√†nh c√¥ng: {success_rate:.1f}%")
        
        # Overall assessment
        print(f"\nüèÜ ƒê√ÅNH GI√Å T·ªîNG TH·ªÇ:")
        if success_rate >= 80:
            print("   üéâ H·ªÜ TH·ªêNG HO·∫†T ƒê·ªòNG C·ª∞C K·ª≤ HI·ªÜU QU·∫¢!")
            print("   ‚úÖ T√≠nh ƒë·ªìng nh·∫•t: XU·∫§T S·∫ÆC")
            print("   ‚úÖ Kh·∫£ nƒÉng l√†m vi·ªác nh√≥m: XU·∫§T S·∫ÆC")
            print("   ‚úÖ S·∫µn s√†ng cho production")
        elif success_rate >= 60:
            print("   üëç H·ªÜ TH·ªêNG HO·∫†T ƒê·ªòNG T·ªêT!")
            print("   ‚úÖ T√≠nh ƒë·ªìng nh·∫•t: T·ªêT")
            print("   ‚úÖ Kh·∫£ nƒÉng l√†m vi·ªác nh√≥m: T·ªêT")
            print("   ‚ö†Ô∏è C·∫ßn m·ªôt s·ªë c·∫£i thi·ªán nh·ªè")
        elif success_rate >= 40:
            print("   ‚ö†Ô∏è H·ªÜ TH·ªêNG HO·∫†T ƒê·ªòNG TRUNG B√åNH")
            print("   ‚ö†Ô∏è T√≠nh ƒë·ªìng nh·∫•t: TRUNG B√åNH")
            print("   ‚ö†Ô∏è Kh·∫£ nƒÉng l√†m vi·ªác nh√≥m: TRUNG B√åNH")
            print("   üîß C·∫ßn c·∫£i thi·ªán ƒë√°ng k·ªÉ")
        else:
            print("   ‚ùå H·ªÜ TH·ªêNG C·∫¶N KH·∫ÆC PH·ª§C NGHI√äM TR·ªåNG")
            print("   ‚ùå T√≠nh ƒë·ªìng nh·∫•t: Y·∫æU")
            print("   ‚ùå Kh·∫£ nƒÉng l√†m vi·ªác nh√≥m: Y·∫æU")
            print("   üö® Kh√¥ng n√™n s·ª≠ d·ª•ng trong production")
        
        # Detailed recommendations
        print(f"\nüí° KHUY·∫æN NGH·ªä:")
        
        if 'system_health' in self.test_results:
            health_data = self.test_results['system_health']
            unhealthy_systems = [name for name, data in health_data.get('individual_systems', {}).items() 
                               if data.get('status') != 'HEALTHY']
            if unhealthy_systems:
                print(f"   üîß Kh·∫Øc ph·ª•c c√°c systems: {', '.join(unhealthy_systems)}")
        
        if 'teamwork_metrics' in self.test_results:
            teamwork = self.test_results['teamwork_metrics']
            if 'data_flow' in teamwork:
                failed_flows = [flow for flow, status in teamwork['data_flow'].items() if not status]
                if failed_flows:
                    print(f"   üîÑ C·∫£i thi·ªán data flow: {', '.join(failed_flows)}")
        
        if 'real_time_performance' in self.test_results:
            performance = self.test_results['real_time_performance']
            low_performance = [metric for metric, score in performance.items() if score < 50]
            if low_performance:
                print(f"   ‚ö° T·ªëi ∆∞u performance: {', '.join(low_performance)}")
        
        # Save results
        self.test_results['end_time'] = end_time
        self.test_results['test_duration_seconds'] = test_duration.total_seconds()
        self.test_results['success_rate'] = success_rate
        
        filename = f"system_integration_teamwork_test_results_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(self.test_results, f, indent=2, ensure_ascii=False, default=str)
        
        print(f"\nüìÅ B√°o c√°o chi ti·∫øt ƒë√£ l∆∞u: {filename}")
        print(f"üéâ TEST HO√ÄN TH√ÄNH!")

def main():
    """Ch·∫°y test ch√≠nh"""
    tester = SystemIntegrationTeamworkTest()
    tester.run_comprehensive_test()

if __name__ == "__main__":
    main() 